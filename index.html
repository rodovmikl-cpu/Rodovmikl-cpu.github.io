<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>schooltrade</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      direction: rtl;
      text-align: center;
      background: linear-gradient(135deg, #e7f0ff, #f9fbff);
      margin-bottom: 200px;
    }
    .box {
      background: white;
      padding: 20px;
      margin: 20px auto;
      border-radius: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      max-width: 420px;
    }
    input, textarea {
      width: 90%; padding: 10px; margin: 8px 0;
      border-radius: 8px; border: 1px solid #ccc;
      text-align: center;
    }
    button {
      padding: 10px 16px; border: none; background: #0078ff;
      color: white; border-radius: 8px; cursor: pointer;
      margin: 6px; font-weight: bold;
    }
    button:hover { background: #005fcc; }
    video, canvas, img { width: 100%; max-width: 360px; border-radius: 10px; margin-top: 10px; }
    #allPosts { margin-bottom: 100px; }
    #createPost {
      position: fixed; bottom: 0; left: 0; right: 0; background: #fff;
      box-shadow: 0 -2px 12px rgba(0,0,0,0.08);
      padding: 10px; max-width: 420px; margin: 0 auto;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="box" id="registerBox">
    <h2>×”×¨×©××”</h2>
    <input type="text" id="nickname" placeholder="×”×›× ×¡ ×©× ×•×©× ××©×¤×—×”">
    <button id="registerBtn">×”×¨×©×</button>
    <div id="regMessage"></div>
    <div id="showCodeBox" style="display:none;">
      <p>×”×§×•×“ ×©×œ×š:</p>
      <h3 id="generatedCode"></h3>
      <button id="copyCodeBtn">×”×¢×ª×§ ×§×•×“</button>
      <button id="continueBtn">×”××©×š</button>
    </div>
  </div>

  <div class="box" id="loginBox" style="display:none;">
    <h2>×”×ª×—×‘×¨×•×ª</h2>
    <input type="text" id="loginCode" placeholder="×”×›× ×¡ ××ª ×”×§×•×“ ×©×œ×š">
    <button id="loginBtn">×”×ª×—×‘×¨</button>
    <div id="logMessage"></div>
  </div>

  <div class="box" id="welcomeBox" style="display:none;">
    <h2 id="welcomeText"></h2>
    <video id="camera" autoplay playsinline></video><br>
    <button id="capture">ğŸ“¸ ×¦×œ× ×ª××•× ×”</button>
    <canvas id="photo" style="display:none;"></canvas>
    <img id="preview" style="display:none;">
    <button id="logoutBtn">×”×ª× ×ª×§</button>
  </div>

  <div id="allPosts" style="display:none;">
    <h2>ğŸ–¼ ×¤×•×¡×˜×™× ×©×œ ××©×ª××©×™×</h2>
    <div id="postsList"></div>
  </div>

  <div id="createPost" style="display:none;">
    <textarea id="description" placeholder="×›×ª×•×‘ ×ª×™××•×¨ ××• ××§×•× ××¤×’×©"></textarea><br>
    <input type="number" id="price" placeholder="××—×™×¨ (â‚ª)"><br>
    <button id="savePostBtn">ğŸ“¤ ×¤×¨×¡×</button>
  </div>

  <div class="box" id="adminPanel" style="display:none;">
    <h2>× ×™×”×•×œ ×× ×”×œ</h2>
    <div id="usersList"></div>
  </div>

<script>
const supabase = window.supabase.createClient(
  'https://fxskzfjezoolsgqytumw.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ4c2t6Zmplem9vbHNncXl0dW13Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwNTkzODksImV4cCI6MjA3NjYzNTM4OX0.MYIWkWhdVNzlqs53l4a4eJXQJeJpf0bD3kQQCDN-zrI'
);

let savedCode = "", savedName = "";

// === ×”×¨×©××” ===
async function register() {
  const nickname = document.getElementById("nickname").value.trim();
  if (!nickname) return alert("×× × ×”×›× ×¡ ×©× ××œ×");

  const code = Math.floor(100000000 + Math.random() * 900000000).toString();
  const { error } = await supabase.from('users').insert([{ code, name: nickname }]);
  if (error) return alert("×©×’×™××” ×‘×”×¨×©××”: " + error.message);

  savedCode = code;
  savedName = nickname;
  document.getElementById("generatedCode").innerText = code;
  document.getElementById("showCodeBox").style.display = "block";
  document.getElementById("regMessage").innerText = "× ×¨×©××ª ×‘×”×¦×œ×—×”!";
}

// === ×”×ª×—×‘×¨×•×ª ===
async function login() {
  const code = document.getElementById("loginCode").value.trim();
  if (!code) return;

  if (code === "admin") {
    savedCode = code;
    savedName = "×× ×”×œ";
    enterUser(true);
    return;
  }

  const { data, error } = await supabase.from('users').select().eq('code', code).single();
  if (error || !data) return alert("×§×•×“ ×©×’×•×™!");

  savedCode = data.code;
  savedName = data.name;
  enterUser(false);
}

// === ×›× ×™×¡×” ×œ××©×ª××© ===
function enterUser(isAdmin) {
  document.getElementById("registerBox").style.display = "none";
  document.getElementById("loginBox").style.display = "none";
  document.getElementById("welcomeBox").style.display = "block";
  document.getElementById("welcomeText").innerText = "×‘×¨×•×š ×”×‘×, " + savedName;
  document.getElementById("allPosts").style.display = "block";
  document.getElementById("createPost").style.display = isAdmin ? "none" : "block";
  document.getElementById("adminPanel").style.display = isAdmin ? "block" : "none";
  showPosts();
  if (isAdmin) showUsers();
}

// === ×©××™×¨×ª ×¤×•×¡×˜ ===
async function savePost() {
  const desc = document.getElementById("description").value;
  const price = document.getElementById("price").value;
  const photo = document.getElementById("preview").src || "";
  if (!desc) return alert("×× × ×›×ª×•×‘ ×ª×™××•×¨");
  const { error } = await supabase.from('posts').insert([{ usercode: savedCode, name: savedName, desc, price, photo }]);
  if (error) return alert("×©×’×™××” ×‘×¤×¨×¡×•×: " + error.message);
  document.getElementById("description").value = "";
  document.getElementById("price").value = "";
  document.getElementById("preview").style.display = "none";
  showPosts();
}

// === ×”×¦×’×ª ×¤×•×¡×˜×™× ===
async function showPosts() {
  const { data } = await supabase.from('posts').select().order('created_at', { ascending: false });
  const list = document.getElementById("postsList");
  list.innerHTML = "";
  if (!data || data.length === 0) return list.innerHTML = "<p>××™×Ÿ ×¤×•×¡×˜×™×</p>";
  data.forEach(p => {
    const canDelete = savedCode === "admin" || p.usercode === savedCode;
    list.innerHTML += `
      <div class="box">
        ${p.photo ? <img src="${p.photo}"> : ""}
        <h4>${p.name}</h4>
        <p>${p.desc}</p>
        <p>ğŸ’° ${p.price || "×œ×œ× ××—×™×¨"}</p>
        ${canDelete ? <button onclick="deletePost('${p.id}')">âŒ ××—×§</button> : ""}
      </div>`;
  });
}

// === ××—×™×§×ª ×¤×•×¡×˜ ===
async function deletePost(id) {
  await supabase.from('posts').delete().eq('id', id);
  showPosts();
}

// === ×¨×©×™××ª ××©×ª××©×™× ×œ××“××™×Ÿ ===
async function showUsers() {
  const { data } = await supabase.from('users').select();
  const usersList = document.getElementById("usersList");
  usersList.innerHTML = "<h3>××©×ª××©×™× ×¨×©×•××™×:</h3>";
  if (!data || data.length === 0) return usersList.innerHTML += "<p>××™×Ÿ ××©×ª××©×™×</p>";
  data.forEach(u => {
    usersList.innerHTML += `
      <div>
        <b>${u.name}</b> (${u.code})
        <button onclick="deleteUser('${u.code}')">ğŸ—‘ ××—×§</button>
      </div>`;
  });
}

// === ××—×™×§×ª ××©×ª××© ×•×›×œ ×”×¤×•×¡×˜×™× ×©×œ×• ===
async function deleteUser(code) {
  if (!confirm("×œ××—×•×§ ××©×ª××© ×–×” ×•×›×œ ×”×¤×•×¡×˜×™× ×©×œ×•?")) return;
  await supabase.from('posts').delete().eq('usercode', code);
  await supabase.from('users').delete().eq('code', code);
  showUsers();
  showPosts();
}

// === ××¦×œ××” ===
const video = document.getElementById("camera");
navigator.mediaDevices.getUserMedia({ video: true })
  .then(stream => video.srcObject = stream)
  .catch(() => console.log("camera error"));

document.getElementById("capture").onclick = () => {
  const canvas = document.getElementById("photo");
  const img = document.getElementById("preview");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext("2d").drawImage(video, 0, 0);
  img.src = canvas.toDataURL("image/png");
  img.style.display = "block";
};

document.getElementById("registerBtn").onclick = register;
document.getElementById("loginBtn").onclick = login;
document.getElementById("savePostBtn").onclick = savePost;
document.getElementById("copyCodeBtn").onclick = () => {
  navigator.clipboard.writeText(savedCode);
  alert("×”×§×•×“ ×”×•×¢×ª×§!");
};
document.getElementById("continueBtn").onclick = () => {
  document.getElementById("registerBox").style.display = "none";
  document.getElementById("loginBox").style.display = "block";
};
</script>
</body>
</html>
