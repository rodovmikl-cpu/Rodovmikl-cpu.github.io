<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SchoolTrade</title>
  <style>
    body { font-family:'Arial'; background:linear-gradient(135deg,#f0f4ff,#d9e7ff); text-align:center; direction:rtl; margin-bottom:220px; color:#222; }
    .box { background:#fff; padding:20px; margin:20px auto; border-radius:14px; box-shadow:0 4px 12px rgba(0,0,0,0.1); max-width:420px; }
    input,textarea { width:90%; padding:10px; margin:8px 0; border-radius:8px; border:1px solid #ccc; text-align:center; font-size:15px; }
    button { padding:10px 16px; border:none; background:#0078ff; color:white; border-radius:8px; cursor:pointer; margin:6px; font-weight:bold; transition:0.3s; }
    button:hover { background:#005fcc; }
    video,img { width:100%; max-width:360px; border-radius:10px; margin-top:10px; }
    #regMessage { min-height:20px; margin-top:6px; color:#0a7a00; font-weight:bold; }
    #allPosts { margin-bottom:120px; }
  </style>
</head>
<body>

<div class="box" id="registerBox">
  <h2>×”×¨×©××”</h2>
  <input type="text" id="nickname" placeholder="×”×›× ×¡ ×©× ×•×©× ××©×¤×—×” ×©×œ×š">
  <button id="registerBtn">×”×¨×©×</button>
  <div id="regMessage"></div>
  <div id="showCodeBox" style="display:none;">
    <p>×”×§×•×“ ×©×œ×š:</p>
    <h3 id="generatedCode"></h3>
    <button id="copyCodeBtn">×”×¢×ª×§ ×§×•×“</button>
    <p>×©××•×¨ ××ª ×”×§×•×“ â€” ×ª×¦×˜×¨×š ××•×ª×• ×›×“×™ ×œ×”×ª×—×‘×¨!</p>
    <button id="continueBtn">×”××©×š</button>
  </div>
</div>

<div class="box" id="loginBox" style="display:none;">
  <h2>×”×ª×—×‘×¨×•×ª</h2>
  <input type="text" id="loginCode" placeholder="×”×›× ×¡ ××ª ×”×§×•×“">
  <button id="loginBtn">×”×ª×—×‘×¨</button>
  <div id="logMessage"></div>
</div>

<div class="box" id="welcomeBox" style="display:none;">
  <h2 id="welcomeText"></h2>
  <video id="camera" autoplay playsinline></video><br>
  <button id="capture">ğŸ“¸ ×¦×œ× ×ª××•× ×”</button>
  <canvas id="photo" style="display:none;"></canvas>
  <img id="preview" style="display:none;">
  <button id="logoutBtn">ğŸ”’ ×”×ª× ×ª×§</button>
</div>

<div class="box" id="adminBox" style="display:none;">
  <h2>âš™ × ×™×”×•×œ ×× ×”×œ</h2>
  <div id="usersList"></div>
  <hr>
  <button id="clearAll">ğŸ—‘ ××—×§ ××ª ×›×œ ×”×¤×•×¡×˜×™×</button>
</div>

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.35.0/dist/supabase.min.js"></script>

<script>
  // ===== Supabase =====
  const supabaseUrl = "https://fxskzfjezoolsgqytumw.supabase.co";
  const supabaseKey = "YOUR_SUPABASE_KEY";
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  // ===== Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ =====
  let users = JSON.parse(localStorage.getItem("users")||"{}");
  let posts = JSON.parse(localStorage.getItem("posts")||"[]");
  let savedCode="", savedName="";

  function saveData(){ localStorage.setItem("users",JSON.stringify(users)); localStorage.setItem("posts",JSON.stringify(posts)); }

  // ===== Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ =====
  function register(){
    const nickname=document.getElementById("nickname").value.trim();
    if(!nickname){document.getElementById("regMessage").innerText="×× × ×”×›× ×¡ ×©× ××©×ª××©";return;}
    let code; do{code=Math.floor(100000000+Math.random()*900000000).toString();}while(users[code]);
    users[code]={name:nickname}; saveData();
    savedName=nickname; savedCode=code;
    document.getElementById("generatedCode").innerText=code;
    document.getElementById("showCodeBox").style.display="block";
    document.getElementById("regMessage").innerText="× ×¨×©××ª ×‘×”×¦×œ×—×” â€” ×©××•×¨ ××ª ×”×§×•×“!";
  }

  function continueToLogin(){ document.getElementById("registerBox").style.display="none"; document.getElementById("loginBox").style.display="block"; }

  // ===== login =====
  function login(){
    const loginCode=document.getElementById("loginCode").value.trim();
    document.getElementById("logMessage").innerText="";
    if(loginCode==="admin"){ savedCode=loginCode; savedName=loginCode; showAdmin(); return; }
    if(users[loginCode]){ savedCode=loginCode; savedName=users[loginCode].name; enterUser(); }
    else{ document.getElementById("logMessage").innerText="×§×•×“ ×©×’×•×™!"; }
  }

  function enterUser(){
    document.getElementById("loginBox").style.display="none";
    document.getElementById("welcomeBox").style.display="block";
    document.getElementById("welcomeText").innerText="×‘×¨×•×š ×”×‘×, "+savedName+"!";
    startCamera();
  }

  function logout(){
    document.getElementById("welcomeBox").style.display="none";
    document.getElementById("adminBox").style.display="none";
    document.getElementById("registerBox").style.display="block";
    document.getElementById("showCodeBox").style.display="none";
    document.getElementById("nickname").value="";
    savedCode=""; savedName="";
  }

  // ===== ĞºĞ°Ğ¼ĞµÑ€Ğ° =====
  function startCamera(){
    const video=document.getElementById('camera');
    navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})
      .then(stream=>{video.srcObject=stream;})
      .catch(err=>{console.warn('âš  ×©×’×™××” ×‘××¦×œ××”:',err);});
  }

  document.getElementById("capture").addEventListener("click",async()=>{
    const video=document.getElementById('camera');
    const canvas=document.getElementById('photo');
    const preview=document.getElementById('preview');
    canvas.width=video.videoWidth; canvas.height=video.videoHeight;
    canvas.getContext('2d').drawImage(video,0,0,canvas.width,canvas.height);
    const dataUrl=canvas.toDataURL('image/png');
    preview.src=dataUrl; preview.style.display='block';

    // upload to Supabase
    if(savedCode!=="admin"&&savedCode){
      const blob=await(await fetch(dataUrl)).blob();
      const fileName=photos/${savedCode}_${Date.now()}.png;
      const {error}=await supabase.storage.from('photos').upload(fileName,blob,{upsert:true});
      if(error) console.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸:",error);
      else console.log("Ğ¤Ğ¾Ñ‚Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾ Ğ² Supabase:",fileName);
    }
  });

  // ===== admin =====
  function showAdmin(){
    document.getElementById("loginBox").style.display="none";
    document.getElementById("adminBox").style.display="block";
    renderUsersList();
  }

  function renderUsersList(){
    const container=document.getElementById("usersList");
    container.innerHTML="";
    for(const code in users){
      const user=users[code];
      const div=document.createElement('div');
      div.innerHTML=${user.name} (${code}) <button onclick="deleteAccount('${code}')">××—×§</button>;
      container.appendChild(div);
    }
  }

  async function deleteAccount(code){
    try{
      const {data,error}=await supabase.storage.from('photos').list('',{search:code});
      if(data) for(const f of data){ await supabase.storage.from('photos').remove([f.name]); }
    }catch(e){console.error(e);}
    delete users[code]; posts=posts.filter(p=>p.ownerCode!==code);
    saveData(); renderUsersList();
  }

  document.getElementById("clearAll").addEventListener("click",()=>{
Â Â Â Â if(confirm
