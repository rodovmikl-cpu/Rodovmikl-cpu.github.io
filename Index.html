<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SchoolTrade â€” with Supabase</title>
  <link rel="icon" href="data:,">
  <style>
    body { font-family:'Arial',sans-serif; background:linear-gradient(135deg,#f0f4ff,#d9e7ff); text-align:center; direction:rtl; margin-bottom:220px; color:#222; }
    .box{ background:#fff; padding:20px; margin:20px auto; border-radius:14px; box-shadow:0 4px 12px rgba(0,0,0,.1); max-width:420px; }
    input,textarea{ width:90%; padding:10px; margin:8px 0; border-radius:8px; border:1px solid #ccc; text-align:center; font-size:15px; }
    button{ padding:10px 16px; border:none; background:#0078ff; color:#fff; border-radius:8px; cursor:pointer; margin:6px; font-weight:bold; transition:.2s; }
    button:hover{ background:#005fcc; }
    .deleteBtn{ background:#ff5252; }
    .deleteBtn:hover{ background:#c62828; }
    video,img,canvas{ width:100%; max-width:360px; border-radius:10px; margin-top:10px; }
    .list-item{ display:flex; justify-content:space-between; align-items:center; padding:6px 0; border-bottom:1px solid #eee; text-align:right; }
    .post-row img{ max-width:120px; border-radius:8px; display:inline-block; vertical-align:middle; margin-left:8px; }
    .post-row .meta{ text-align:right; display:inline-block; vertical-align:middle; }
    #regMessage,#logMessage,#adminMsg{ min-height:20px; margin-top:6px; font-weight:bold; color:#0a7a00; }
    .small{ font-size:12px; color:#666; }
  </style>
</head>
<body>

  <!-- Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ -->
  <div class="box" id="registerBox">
    <h2>×”×¨×©××”</h2>
    <input id="nickname" placeholder="×”×›× ×¡ ×©× ×•×©× ××©×¤×—×” ×©×œ×š" />
    <button id="registerBtn">×”×¨×©×</button>
    <div id="regMessage"></div>

    <div id="showCodeBox" style="display:none;">
      <p>×”×§×•×“ ×©×œ×š:</p>
      <h3 id="generatedCode"></h3>
      <button id="copyCodeBtn">×”×¢×ª×§ ×§×•×“</button>
      <p class="small">×©××•×¨ ××ª ×”×§×•×“ â€” ×ª×¦×˜×¨×š ××•×ª×• ×›×“×™ ×œ×”×ª×—×‘×¨!</p>
      <button id="continueBtn">×”××©×š</button>
    </div>
  </div>

  <!-- Ğ²Ñ…Ğ¾Ğ´ -->
  <div class="box" id="loginBox" style="display:none;">
    <h2>×”×ª×—×‘×¨×•×ª</h2>
    <input id="loginCode" placeholder="×”×›× ×¡ ××ª ×”×§×•×“" />
    <button id="loginBtn">×”×ª×—×‘×¨</button>
    <div id="logMessage"></div>
  </div>

  <!-- Ğ¿Ñ€Ğ¸Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğµ + ĞºĞ°Ğ¼ĞµÑ€Ğ° -->
  <div class="box" id="welcomeBox" style="display:none;">
    <h2 id="welcomeText"></h2>
    <video id="camera" autoplay playsinline></video><br>
    <button id="capture">ğŸ“¸ ×¦×œ× ×ª××•× ×”</button>
    <canvas id="photo" style="display:none;"></canvas>
    <img id="preview" style="display:none;" alt="preview" />
    <div style="margin-top:8px;">
      <button id="savePostBtn" style="display:none;">ğŸ’¾ ×©××•×¨ ×¤×•×¡×˜ (×”×¢×œ×” ×œÖ¾Supabase)</button>
      <button id="logoutBtn">ğŸ”’ ×”×ª× ×ª×§</button>
    </div>
  </div>

  <!-- Ğ²ÑĞµ Ğ¿Ğ¾ÑÑ‚Ñ‹ -->
  <div class="box" id="allPosts" style="display:none;">
    <h2>ğŸ–¼ ×¤×•×¡×˜×™× ×©×œ ××©×ª××©×™×</h2>
    <div id="postsList"></div>
  </div>

  <!-- Ğ°Ğ´Ğ¼Ğ¸Ğ½ -->
  <div class="box" id="adminBox" style="display:none;">
    <h2>âš™ × ×™×”×•×œ ×× ×”×œ</h2>
    <h3>×¨×©×™××ª ×—×©×‘×•× ×•×ª</h3>
    <div id="usersList"></div>
    <hr />
    <h3>×¤×•×¡×˜×™×:</h3>
    <div id="adminPostsList"></div>
    <div id="adminMsg"></div>
    <div style="margin-top:8px;">
      <button id="clearAllBtn">ğŸ—‘ ××—×§ ××ª ×›×œ ×”×¤×•×¡×˜×™×</button>
      <button id="exitAdminBtn">ğŸ”™ ×—×–×•×¨</button>
    </div>
  </div>

  <!-- Supabase SDK (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.35.0/dist/supabase.min.js"></script>

  <script>
    // ====== Ğ’ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½ Ñ‚Ğ²Ğ¾Ğ¹ Supabase URL Ğ¸ Key (ĞºĞ°Ğº Ñ‚Ñ‹ Ğ¿Ñ€Ğ¾ÑĞ¸Ğ») ======
    const SUPABASE_URL = "https://fxskzfjezoolsgqytumw.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ4c2t6Zmplem9vbHNncXl0dW13Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwNTkzODksImV4cCI6MjA3NjYzNTM4OX0.MYIWkWhdVNzlqs53l4a4eJXQJeJpf0bD3kQQCDN-zrI";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // local storage (ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ ĞºĞ¾Ğ¿Ğ¸Ñ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾ ĞºĞ°Ğº Ñƒ Ñ‚ĞµĞ±Ñ Ğ±Ñ‹Ğ»Ğ¾)
    let users = JSON.parse(localStorage.getItem("users") || "{}");
    let posts = JSON.parse(localStorage.getItem("posts") || "[]");

    let savedCode = "";
    let savedName = "";

    function saveLocal(){
      localStorage.setItem("users", JSON.stringify(users));
      localStorage.setItem("posts", JSON.stringify(posts));
    }

    // ---------- Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ ----------
    document.getElementById("registerBtn").addEventListener("click", async () => {
      const nickname = (document.getElementById("nickname").value || "").trim();
      if(!nickname){ document.getElementById("regMessage").innerText = "×× × ×”×›× ×¡ ×©× ××©×ª××©"; return; }

      let code;
      do { code = Math.floor(100000000 + Math.random()*900000000).toString(); } while(users[code]);

      users[code] = { name: nickname };
      saveLocal();

      // ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ² Supabase (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ° â€” ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚, Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ»Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼)
      try {
        const { error } = await supabase.from('users').insert([{ id: code, name: nickname }]);
        if(error && !/duplicate/i.test(error.message)){ console.warn("supabase users insert error:", error); }
      } catch(e){ console.error("supabase users insert exception:", e); }

      savedCode = code;
      savedName = nickname;

      document.getElementById("generatedCode").innerText = code;
      document.getElementById("showCodeBox").style.display = "block";
      document.getElementById("regMessage").innerText = "× ×¨×©××ª ×‘×”×¦×œ×—×” â€” ×©××•×¨ ××ª ×”×§×•×“!";
    });

    document.getElementById("continueBtn").addEventListener("click", () => {
      document.getElementById("registerBox").style.display = "none";
      document.getElementById("loginBox").style.display = "block";
    });

    // ---------- Login ----------
    document.getElementById("loginBtn").addEventListener("click", async () => {
      const loginCode = (document.getElementById("loginCode").value || "").trim();
      document.getElementById("logMessage").innerText = "";
      if(!loginCode){ document.getElementById("logMessage").innerText = "×”×›× ×¡ ×§×•×“!"; return; }

      if(loginCode === "admin"){
        savedCode = loginCode; savedName = loginCode;
        // show admin panel
        document.getElementById("loginBox").style.display = "none";
        document.getElementById("adminBox").style.display = "block";
        await renderUsersList();
        await renderAdminPosts();
        return;
      }

      // Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾ â€” Ñ‚Ğ°Ğº ĞºĞ°Ğº Ñ‚Ñ‹ Ñ…Ğ¾Ñ‚ĞµĞ» ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ¿Ñ€ĞµĞ¶Ğ½ĞµĞµ Ğ¿Ğ¾Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ
      if(users[loginCode]){
        savedCode = loginCode;
        savedName = users[loginCode].name;
        enterUser();
        return;
      }

      // ĞºĞ°Ğº Ğ·Ğ°Ğ¿Ğ°ÑĞ½Ğ¾Ğ¹ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚, Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¸Ğ· supabase
      try {
        const { data, error } = await supabase.from('users').select('id,name').eq('id', loginCode).limit(1).maybeSingle();
        if(error){ console.warn("supabase users select error:", error); }
        if(data && data.id){
          users[data.id] = { name: data.name };
          saveLocal();
          savedCode = data.id;
          savedName = data.name;
          enterUser();
          return;
        }
      } catch(e){ console.error(e); }

      document.getElementById("logMessage").innerText = "×§×•×“ ×©×’×•×™!";
    });

    function enterUser(){
      document.getElementById("loginBox").style.display = "none";
      document.getElementById("welcomeBox").style.display = "block";
      document.getElementById("allPosts").style.display = "block";
      document.getElementById("welcomeText").innerText = "×‘×¨×•×š ×”×‘×, " + savedName + "!";
      startCamera();
      // Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ² (Ğ±ĞµÑ€Ñ‘Ğ¼ Ğ¸Ğ· Supabase + local)
      fetchAndShowPosts();
    }

    document.getElementById("logoutBtn").addEventListener("click", () => {
      logout();
    });

    function logout(){
      document.getElementById("welcomeBox").style.display = "none";
      document.getElementById("adminBox").style.display = "none";
      document.getElementById("allPosts").style.display = "none";
      document.getElementById("registerBox").style.display = "block";
      document.getElementById("showCodeBox").style.display = "none";
      document.getElementById("nickname").value = "";
      savedCode = ""; savedName = "";
    }

    // ---------- ĞšĞ°Ğ¼ĞµÑ€Ğ° Ğ¸ Ñ„Ğ¾Ñ‚Ğ¾ ----------
    async function startCamera(){
      const video = document.getElementById('camera');
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }});
        video.srcObject = stream;
      } catch(e){
        console.warn("camera error", e);
        alert("××™×Ÿ ×’×™×©×” ×œ××¦×œ××” â€” ×‘×“×•×§ ×”×¨×©××•×ª.");
      }
    }

    document.getElementById("capture").addEventListener("click", async () => {
      const video = document.getElementById('camera');
      const canvas = document.getElementById('photo');
      const preview = document.getElementById('preview');
      try {
        if(!video.videoWidth){ alert("×”××ª×Ÿ ×œ×˜×¢×™× ×” ×©×œ ×”××¦×œ××”"); return; }
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
        const dataUrl = canvas.toDataURL('image/png');
        preview.src = dataUrl;
        preview.style.display = 'block';
        // Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ
        document.getElementById("savePostBtn").style.display = 'inline-block';
      } catch(e){
        console.error("capture error", e);
      }
    });

    // ---------- Save post: upload photo -> create post record ----------
    document.getElementById("savePostBtn").addEventListener("click", async () => {
      if(!savedCode || savedCode === "admin"){ alert("×¨×§ ××©×ª××©×™× ×™×›×•×œ×™× ×œ×¤×¨×¡×"); return; }
      const preview = document.getElementById('preview');
      if(!preview.src){ alert("××™×Ÿ ×ª××•× ×” ×œ×©××™×¨×”"); return; }

      // Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ Ñƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ Ğ»Ğ¾Ğ¼Ğ°Ñ‚ÑŒ UI)
      const desc = prompt("×”×›× ×¡ ×ª×™××•×¨ ×§×¦×¨ ×œ×¤×•×¡×˜ (××• ×œ×—×¥ ×‘×™×˜×•×œ):", "") || "";

      try {
        // 1) Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ² Storage (bucket photos) â€” path: <usercode>_<timestamp>.png
        const blob = await (await fetch(preview.src)).blob();
        const filename = ${savedCode}_${Date.now()}.png;
        const uploadPath = filename; // Ğ² bucket photos ĞºĞ¾Ñ€Ğ½ĞµĞ²Ğ¾Ğ¹ Ğ¿ÑƒÑ‚ÑŒ
        const { error: uploadError } = await supabase.storage.from('photos').upload(uploadPath, blob, { upsert: false });
        if(uploadError){
          // ĞµÑĞ»Ğ¸ Ñ„Ğ°Ğ¹Ğ» ÑƒĞ¶Ğµ ĞµÑÑ‚ÑŒ â€” Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ Ñ upsert=true
          console.warn("upload error, retry with upsert:", uploadError);
          const { error: upErr } = await supabase.storage.from('photos').upload(uploadPath, blob, { upsert: true });
          if(upErr){ throw upErr; }
        }

        // 2) Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿ÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ URL
        const { data: urlData } = supabase.storage.from('photos').getPublicUrl(uploadPath);
        const publicUrl = urlData && urlData.publicUrl ? urlData.publicUrl : null;

        // 3) ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğµ posts
        const postId = ${Date.now()}_${Math.random().toString(36).slice(2,9)};
        const postRecord = {
          id: postId,
          usercode: savedCode,
          name: savedName,
          photo_url: publicUrl,
          desc: desc,
          created_at: new Date().toISOString()
        };
        const { error: insertError } = await supabase.from('posts').insert([postRecord]);
        if(insertError){ console.warn("insert post error:", insertError); alert("×©×’×™××” ×‘×©××™×¨×ª ×”×¤×•×¡×˜"); return; }

        // 4) Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾ Ñ‚Ğ¾Ğ¶Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ¼ (ĞºĞ°Ğº ĞºĞ¾Ğ¿Ğ¸Ñ)
        posts.push(postRecord);
        saveLocal();

        alert("×¤×•×¡×˜ × ×©××¨ ×‘×”×¦×œ×—×”!");
        // Ğ¾Ñ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ preview
        preview.src = "";
        preview.style.display = "none";
        document.getElementById("savePostBtn").style.display = "none";
        // Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ²
        fetchAndShowPosts();

      } catch(e){
        console.error("savePost error:", e);
        alert("×©×’×™××” ×‘×¢×ª ×©××™×¨×ª ×”×¤×•×¡×˜, ×‘×“×•×§ ××ª ×”×§×•× ×¡×•×œ.");
      }
    });

    // ---------- ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¸ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¿Ğ¾ÑÑ‚Ñ‹ (Ğ¸Ğ· Supabase, fallback local) ----------
    async function fetchAndShowPosts(){
      const container = document.getElementById("postsList");
      container.innerHTML = "×˜×•×¢×Ÿ...";
      try {
        const { data, error } = await supabase.from('posts').select('*').order('created_at',{ascending:false});
        let allPosts = [];
        if(error){ console.warn("supabase posts select error:", error); allPosts = posts.slice().reverse(); }
        else { allPosts = (data && data.length) ? data.slice().reverse() : posts.slice().reverse(); }
        renderPosts(container, allPosts);
      } catch(e){
        console.error(e);
        renderPosts(document.getElementById("postsList"), posts.slice().reverse());
      }
    }

    function renderPosts(container, postArray){
      container.innerHTML = "";
      if(!postArray || postArray.length===0){ container.innerHTML = "<div class='small'>××™×Ÿ ×¤×•×¡×˜×™× ×œ×”×¦×™×’</div>"; return; }
      postArray.forEach(p=>{
        const div = document.createElement('div');
        div.className = 'post-row';
        div.style.padding = '8px';
        div.style.borderBottom = '1px solid #eee';
        div.innerHTML = `
          <div class="meta">
            <strong>${p.name || '××©×ª××©'}</strong><br>
            <span class="small">${p.desc || ''}</span><br>
            <span class="small">${p.created_at ? new Date(p.created_at).toLocaleString() : ''}</span>
          </div>
          ${p.photo_url ? <img src="${p.photo_url}" alt="photo" /> : ''}
        `;
        container.appendChild(div);
      });
    }

    // ---------- ĞĞ´Ğ¼Ğ¸Ğ½: ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ (Ğ±ĞµÑ€Ñ‘Ğ¼ Ğ¸Ğ· Supabase ĞµÑĞ»Ğ¸ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾) ----------
    async function renderUsersList(){
      const c = document.getElementById("usersList");
      c.innerHTML = "×˜×•×¢×Ÿ...";
      try {
        const { data, error } = await supabase.from('users').select('*').order('id',{ascending:true});
        let userArray = [];
        if(error){ console.warn("supabase users select error:", error); userArray = Object.keys(users).map(k=>({id:k,name:users[k].name})); }
        else userArray = data && data.length ? data : Object.keys(users).map(k=>({id:k,name:users[k].name}));
        c.innerHTML = "";
        if(userArray.length===0){ c.innerHTML = "<div class='small'>××™×Ÿ ××©×ª××©×™×</div>"; return; }
        userArray.forEach(u=>{
          const row = document.createElement('div');
          row.className = 'list-item';
          row.innerHTML = <div>${u.name} (${u.id})</div><div><button class="deleteBtn">××—×§</button></div>;
          row.querySelector('button').addEventListener('click', ()=> deleteAccount(u.id, u.name, row));
          c.appendChild(row);
        });
      } catch(e){
        console.error(e);
        c.innerHTML = "<div class='small'>×©×’×™××” ×‘×˜×¢×™× ×ª ××©×ª××©×™×</div>";
      }
    }

    // ---------- ĞĞ´Ğ¼Ğ¸Ğ½: ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ² ----------
    async function renderAdminPosts(){
      const c = document.getElementById("adminPostsList");
      c.innerHTML = "×˜×•×¢×Ÿ...";
      try {
        const { data, error } = await supabase.from('posts').select('*').order('created_at',{ascending:false});
        if(error){ console.warn("supabase posts select error:", error); c.innerHTML = "<div class='small'>×©×’×™××” ×‘×˜×¢×™× ×ª ×¤×•×¡×˜×™×</div>"; return; }
        if(!data || data.length===0){ c.innerHTML = "<div class='small'>××™×Ÿ ×¤×•×¡×˜×™×</div>"; return; }
        c.innerHTML = "";
        data.forEach(p=>{
          const row = document.createElement('div');
          row.className = 'post-row';
          row.style.padding = '8px';
          row.style.borderBottom = '1px solid #eee';
          row.innerHTML = `
            ${p.photo_url ? <img src="${p.photo_url}" alt="photo"/> : ''}
            <div class="meta" style="display:inline-block; margin-right:8px; text-align:right;">
              <strong>${p.name || '××©×ª××©'}</strong><br>
              <span class="small">${p.desc || ''}</span><br>
              <span class="small">${p.created_at ? new Date(p.created_at).toLocaleString():''}</span>
            </div>
            <div style="display:inline-block; margin-left:10px;"><button class="deleteBtn">××—×§</button></div>
          `;
          row.querySelector('button').addEventListener('click', ()=> deletePostById(p.id, row, p.photo_url));
          c.appendChild(row);
        });
      } catch(e){
        console.error(e);
        c.innerHTML = "<div class='small'>×©×’×™××” ×‘×˜×¢×™× ×ª ×¤×•×¡×˜×™×</div>";
      }
    }

    // ---------- Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ÑÑ‚Ğ° (Ğ°Ğ´Ğ¼Ğ¸Ğ½) ----------
    async function deletePostById(postId, elementNode, photoUrl){
      if(!confirm("×œ××—×•×§ ×¤×•×¡×˜ ×–×”?")) return;
      try {
        // ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ¸Ğ· Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ posts
        const { error: delErr } = await supabase.from('posts').delete().eq('id', postId);
        if(delErr){ console.warn("supabase delete post error:", delErr); alert("×©×’×™××” ×‘××—×™×§×”"); return; }

        // ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ñ„Ğ°Ğ¹Ğ» Ğ¸Ğ· storage ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ
        if(photoUrl){
          const path = extractPathFromPublicUrl(photoUrl);
          if(path){
            const { error: rmErr } = await supabase.storage.from('photos').remove([path]);
            if(rmErr) console.warn("ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ñ„Ğ°Ğ¹Ğ»Ğ° storage:", rmErr);
          }
        }

        // ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½ÑƒÑ ĞºĞ¾Ğ¿Ğ¸Ñ (ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ)
        posts = posts.filter(p => p.id !== postId);
        saveLocal();

        if(elementNode && elementNode.remove) elementNode.remove();
        alert("×”×¤×•×¡×˜ × ××—×§ ×‘×”×¦×œ×—×”!");
        // Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº
        fetchAndShowPosts();
      } catch(e){
        console.error(e); alert("×©×’×™××” ×‘××—×™×§×” â€” ×‘×“×•×§ ×§×•× ×¡×•×œ");
      }
    }

    // ---------- Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ° (Ğ°Ğ´Ğ¼Ğ¸Ğ½) ----------
    async function deleteAccount(userCode, userName, rowNode){
      if(!confirm(×œ××—×•×§ ××ª ×”××©×ª××© ${userName} ×•×›×œ ×¤×•×¡×˜×™× ×©×œ×•?)) return;
      try {
        // 1) Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ Ğ¿Ğ¾ÑÑ‚Ñ‹ ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
        const { data: userPosts, error: pErr } = await supabase.from('posts').select('*').eq('usercode', userCode);
        if(pErr){ console.warn("supabase select posts error for user:", pErr); }

        if(userPosts && userPosts.length){
          // ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ¿Ğ¾ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼Ñƒ Ğ¿Ğ¾ÑÑ‚Ñƒ
          for(const p of userPosts){
            if(p.photo_url){
              const path = extractPathFromPublicUrl(p.photo_url);
              if(path){
                const { error: rmErr } = await supabase.storage.from('photos').remove([path]);
                if(rmErr) console.warn("ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ñ„Ğ°Ğ¹Ğ»Ğ°:", rmErr);
              }
            }
          }
          // ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ posts
          const { error: delPostsErr } = await supabase.from('posts').delete().eq('usercode', userCode);
          if(delPostsErr) console.warn("ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ posts:", delPostsErr);
        }

        // ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ² Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğµ users
        const { error: delUserErr } = await supabase.from('users').delete().eq('id', userCode);
        if(delUserErr) console.warn("ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ supabase:", delUserErr);

        // ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾
        delete users[userCode];
        posts = posts.filter(p => p.usercode !== userCode);
        saveLocal();

        if(rowNode && rowNode.remove) rowNode.remove();
        alert(×”××©×ª××© ${userName} × ××—×§ ×‘×”×¦×œ×—×”!);
        // Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞºĞ¸
        renderUsersList();
        renderAdminPosts();
        fetchAndShowPosts();
      } catch(e){
        console.error(e);
        alert("×©×’×™××” ×‘××—×™×§×ª ×”××©×ª××© â€” ×‘×“×•×§ ×§×•× ×¡×•×œ");
      }
    }

    // ---------- Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ²ÑÑ‘ (Ğ°Ğ´Ğ¼Ğ¸Ğ½) ----------
    document.getElementById("clearAllBtn").addEventListener("click", async () => {
      if(!confirm("×œ××—×•×§ ××ª ×›×œ ×”×¤×•×¡×˜×™× ××›×œ ×”××©×ª××©×™×?")) return;
      try {
        // Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ Ğ¿Ğ¾ÑÑ‚Ñ‹
        const { data: allPosts, error } = await supabase.from('posts').select('*');
        if(error){ console.warn("error fetching posts:", error); alert("×©×’×™××” ×‘×˜×¢×™× ×ª ×”×¤×•×¡×˜×™×"); return; }
        // ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ Ñ„Ğ°Ğ¹Ğ»Ñ‹
Â Â Â Â Â Â Â Â for
